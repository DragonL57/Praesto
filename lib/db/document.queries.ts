import 'server-only';

import {
    and,
    asc,
    desc,
    eq,
    gt,
} from 'drizzle-orm';
import { drizzle } from 'drizzle-orm/postgres-js';
import postgres from 'postgres';

import {
    document,
    suggestion,
} from './schema';
import type { ArtifactKind } from '@/components/artifact';

// biome-ignore lint: Forbidden non-null assertion.
const client = postgres(process.env.POSTGRES_URL!);
const db = drizzle(client);

export async function saveDocument({
    id,
    title,
    kind,
    content,
    userId,
}: {
    id: string;
    title: string;
    kind: ArtifactKind;
    content: string;
    userId: string;
}) {
    try {
        return await db
            .insert(document)
            .values({
                id,
                title,
                kind,
                content,
                userId,
                createdAt: new Date(),
            })
            .returning();
    } catch (error) {
        console.error('Failed to save document in database');
        throw error;
    }
}

export async function getDocumentsById({ id }: { id: string }) {
    try {
        const documents = await db
            .select()
            .from(document)
            .where(eq(document.id, id))
            .orderBy(asc(document.createdAt));

        return documents;
    } catch (error) {
        console.error('Failed to get document by id from database');
        throw error;
    }
}

export async function getDocumentById({ id }: { id: string }) {
    try {
        const [selectedDocument] = await db
            .select()
            .from(document)
            .where(eq(document.id, id))
            .orderBy(desc(document.createdAt));

        return selectedDocument;
    } catch (error) {
        console.error('Failed to get document by id from database');
        throw error;
    }
}

export async function deleteDocumentsByIdAfterTimestamp({
    id,
    timestamp,
}: {
    id: string;
    timestamp: Date;
}) {
    try {
        await db
            .delete(suggestion)
            .where(
                and(
                    eq(suggestion.documentId, id),
                    gt(suggestion.documentCreatedAt, timestamp),
                ),
            );

        return await db
            .delete(document)
            .where(and(eq(document.id, id), gt(document.createdAt, timestamp)))
            .returning();
    } catch (error) {
        console.error(
            'Failed to delete documents by id after timestamp from database',
        );
        throw error;
    }
} 